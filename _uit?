########################################################################
#	In te sluiten in lang durende reeksen of lussen van bash shellopdrachten,
#	om a.d.h.v. de naam van het bronbestand van dit script, die
#	processen te controleren.
#
#	Gebruik in het insluitende script :
#		- stel een variabele in met als naam "epcdir", en als waarde de directory waarin dit
#			script staat:
#				epcdir="moederdirectory van dit bestand/"
#			- het proces moet uitvoeren met schrijftoegang tot die directory, zodat het ingesloten
#				script de naam van zijn bronbestand kan wijzigen als deel van zijn werking
#		- sluit dit script in met de source-opdracht, met een jokerteken voor de
#			verschillende namen van zijn bronbestand als volgt (zie ook sectie 'Werking procescontrole'):
#				source "$epcdir/_uit"*
#				OF
#				. "$epcdir/_uit"*
#		- hou in "$epcdir/" slechts 1 bestand (DIT bestand) met een naam die met dat jokerteken
#			overeenkomt; anders hangt de werking af van de expansie-volgorde van het jokerteken:
#			de naam met de 1ste expansie wordt uitgevoerd, met de andere bestanddsnamen als
#			parameter. Als de expansie geen bestandsnaam vindt, geeft bash een foutboodschap
#			voor de source-opdracht.
#
#	Werking procescontrole :
#		- noem dit bestand "_uit?" om dit script te neutraliseren.
#		- noem dit bestand "_uit" (zonder vraagteken), om de computer uit te schakelen wanneer de shell
#			de plaats bereikt waar dit script is ingesloten; vooraf hernoemt dit script zijn bronbestand
#			tot "_uit?", om geneutraliseerd te beginnen wanneer later nog een proces wordt gestart
#			dat dit script insluit.
#		- om meerdere shell-processsen gecoördineerd de computer te laten uitzetten, wanneer ze
#			elk op een punt gekomen zijn waar dit script is ingesloten, noemt u dit
#			bestand "_uit2" tot "_uit9", met het cijfer gelijk aan het aantal te
#			coördineren shell-processen, maximaal 9 dus. In elk shell-proces dat het punt van
#			insluiting bereikt, verlaagt dit script dat cijfer in de naam van zijn bronbestand
#			 met 1 ("_uit2" hernoemt zich als laatste naar "_uit" i.p.v. "_uit1"), en wacht het
#			tot uiteindelijk de laatste shell op het insluitpunt komt en de computer uitschakelt.
#
#	Benodigdheden :
#		- Een script "~/bin/uit", of elders op het pad, dat de computer ordentelijk uit zet. Dat kan b.v. de
#			opdracht "shutdown now" zijn, met evt. toevoegingen naar wens.
#	
[ -n "$epcdir" -a -f "$epcdir/_uit"  ] && { mv "$epcdir/_uit"  "$epcdir/_uit?"; ~/bin/uit; }
[ -n "$epcdir" -a -f "$epcdir/_uit"[2-9] ] && {
	num=$(echo "$epcdir/_uit"[2-9]);# no pathname expansion in variable assignment, force it with $(echo ...)
	# split of the sequence number and decrement. But rename to _uit instead of _uit1
	num=${num: -1};
	[ $num -gt 2 ] &&
		mv "$epcdir/_uit"[2-9] "$epcdir/_uit"$((num-1)) ||
		mv "$epcdir/_uit"[2-9] "$epcdir/_uit"; 
	echo "Wacht op ander proces dat pc '_uit' zet";
	while true;do sleep 10m; done;
}
